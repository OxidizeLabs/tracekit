name: Release

on:
  push:
    tags:
      - "v*.*.*"

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Ensure tag points to main
        run: |
          # `actions/checkout` is typically shallow; ensure we have enough `origin/main`
          # history for an accurate ancestry check.
          if git rev-parse --is-shallow-repository | grep -q true; then
            git fetch --no-tags --prune --unshallow origin main
          else
            git fetch --no-tags --prune origin main
          fi
          git merge-base --is-ancestor "${GITHUB_SHA}^{}" origin/main
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2

      - name: Format check
        run: cargo fmt --all --check

      - name: Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Tests
        run: cargo test --workspace --all-features --all-targets

      - name: Docs
        run: cargo doc --workspace --no-deps --all-features
        env:
          RUSTDOCFLAGS: -Dwarnings

      - name: Package verification
        run: |
          # Verify each crate can be packaged
          cargo package --package tracekit
          cargo package --package tracekit-formats
          cargo package --package tracekit-cachekit
          cargo package --package tracekit-cli

  release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v6
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true

  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v6
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Publish crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # Publish in dependency order with delays to allow crates.io indexing
          cargo publish --package tracekit
          echo "Waiting for crates.io to index tracekit..."
          sleep 30
          
          cargo publish --package tracekit-formats
          cargo publish --package tracekit-cachekit
          echo "Waiting for crates.io to index dependencies..."
          sleep 30
          
          cargo publish --package tracekit-cli
